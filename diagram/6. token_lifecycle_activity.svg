<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="1001px" preserveAspectRatio="none" style="width:855px;height:1001px;background:#FFFFFF;" version="1.1" viewBox="0 0 855 1001" width="855px" zoomAndPan="magnify"><defs/><g><ellipse cx="445.4834" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="107.8379" x="391.5645" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="87.8379" x="401.5645" y="71.1387">Client Request</text><polygon fill="#F1F1F1" points="398.8193,103.9688,492.1475,103.9688,504.1475,115.9688,492.1475,127.9688,398.8193,127.9688,386.8193,115.9688,398.8193,103.9688" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="93.3281" x="398.8193" y="119.7769">Token Available?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="19.0083" x="367.811" y="113.3745">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="13.7017" x="504.1475" y="113.3745">no</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="146.1348" x="203.7456" y="137.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="126.1348" x="213.7456" y="159.1074">Check isTokenValid()</text><polygon fill="#F1F1F1" points="110.4165,191.9375,443.2095,191.9375,455.2095,203.9375,443.2095,215.9375,110.4165,215.9375,98.4165,203.9375,110.4165,191.9375" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="332.793" x="110.4165" y="207.7456">LocalDateTime.now(ZoneOffset.UTC).isBefore(tokenExpiry)?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="19.0083" x="79.4082" y="201.3433">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="13.7017" x="455.2095" y="201.3433">no</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="149.5156" x="13.6587" y="225.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="129.5156" x="23.6587" y="247.0762">Return existing token</text><ellipse cx="88.4165" cy="290.9063" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="88.4165" cy="290.9063" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="105.793" x="412.313" y="225.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="85.793" x="422.313" y="247.0762">Token expired</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="132.0957" x="548.106" y="137.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="112.0957" x="558.106" y="159.1074">No token available</text><polygon fill="#F1F1F1" points="445.4834,311.9063,457.4834,323.9063,445.4834,335.9063,433.4834,323.9063,445.4834,311.9063" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="157.0801" x="366.9434" y="355.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="137.0801" x="376.9434" y="377.0449">Acquire ReentrantLock</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="95.4629" x="397.752" y="458.2773"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="75.4629" x="407.752" y="479.416">Release lock</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="98.3691" x="396.2988" y="512.2461"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="78.3691" x="406.2988" y="533.3848">Return token</text><ellipse cx="445.4834" cy="577.2148" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="445.4834" cy="577.2148" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><polygon fill="#F1F1F1" points="369.6865,409.875,521.2803,409.875,533.2803,421.875,521.2803,433.875,369.6865,433.875,357.6865,421.875,369.6865,409.875" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="19.0083" x="449.4834" y="444.0854">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="151.5938" x="369.6865" y="425.6831">Double-check: Token valid?</text><polygon fill="#F1F1F1" points="390.4753,630.2148,500.4915,630.2148,512.4915,642.2148,500.4915,654.2148,390.4753,654.2148,378.4753,642.2148,390.4753,630.2148" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="110.0161" x="390.4753" y="646.0229">canRefreshToken()?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="19.0083" x="359.467" y="639.6206">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="13.7017" x="512.4915" y="639.6206">no</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="176.1934" x="129.373" y="664.2148"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="156.1934" x="139.373" y="685.3535">Call refreshAccessToken()</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="167.0117" x="133.9639" y="718.1836"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="147.0117" x="143.9639" y="739.3223">POST to Microsoft Graph</text><polygon fill="#F1F1F1" points="163.2002,772.1523,271.7393,772.1523,283.7393,784.1523,271.7393,796.1523,163.2002,796.1523,151.2002,784.1523,163.2002,772.1523" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="108.5391" x="163.2002" y="787.9604">Refresh successful?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="19.0083" x="132.1919" y="781.5581">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="13.7017" x="283.7393" y="781.5581">no</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="172.0859" x="11" y="806.1523"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="152.0859" x="21" y="827.291">updateTokens() with UTC</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="95.4629" x="49.3115" y="860.1211"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="75.4629" x="59.3115" y="881.2598">Release lock</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="126.9863" x="33.5498" y="914.0898"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="106.9863" x="43.5498" y="935.2285">Return new token</text><ellipse cx="97.043" cy="979.0586" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="97.043" cy="979.0586" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="101.8262" x="286.9834" y="806.1523"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="81.8262" x="296.9834" y="827.291">clearTokens()</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="95.4629" x="290.165" y="860.1211"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="75.4629" x="300.165" y="881.2598">Release lock</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="269.6211" x="203.0859" y="914.0898"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="249.6211" x="213.0859" y="935.2285">Throw TokenException(REFRESH_FAILED)</text><ellipse cx="337.8965" cy="979.0586" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="337.8965" cy="979.0586" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="95.4629" x="625.7656" y="664.2148"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="75.4629" x="635.7656" y="685.3535">Release lock</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="341.5801" x="502.707" y="718.1836"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="321.5801" x="512.707" y="739.3223">Throw TokenException(AUTHENTICATION_REQUIRED)</text><ellipse cx="673.4971" cy="783.1523" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="673.4971" cy="783.1523" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="30" y2="50"/><polygon fill="#181818" points="441.4834,40,445.4834,50,449.4834,40,445.4834,44" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="88.4165" x2="88.4165" y1="259.9063" y2="279.9063"/><polygon fill="#181818" points="84.4165,269.9063,88.4165,279.9063,92.4165,269.9063,88.4165,273.9063" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="98.4165" x2="88.4165" y1="203.9375" y2="203.9375"/><line style="stroke:#181818;stroke-width:1;" x1="88.4165" x2="88.4165" y1="203.9375" y2="225.9375"/><polygon fill="#181818" points="84.4165,215.9375,88.4165,225.9375,92.4165,215.9375,88.4165,219.9375" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="455.2095" x2="465.2095" y1="203.9375" y2="203.9375"/><line style="stroke:#181818;stroke-width:1;" x1="465.2095" x2="465.2095" y1="203.9375" y2="225.9375"/><polygon fill="#181818" points="461.2095,215.9375,465.2095,225.9375,469.2095,215.9375,465.2095,219.9375" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="465.2095" x2="465.2095" y1="259.9063" y2="306.9063"/><line style="stroke:#181818;stroke-width:1;" x1="465.2095" x2="276.813" y1="306.9063" y2="306.9063"/><line style="stroke:#181818;stroke-width:1;" x1="276.813" x2="276.813" y1="306.9063" y2="323.9063"/><line style="stroke:#181818;stroke-width:1;" x1="276.813" x2="433.4834" y1="323.9063" y2="323.9063"/><polygon fill="#181818" points="423.4834,319.9063,433.4834,323.9063,423.4834,327.9063,427.4834,323.9063" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="276.813" x2="276.813" y1="171.9375" y2="191.9375"/><polygon fill="#181818" points="272.813,181.9375,276.813,191.9375,280.813,181.9375,276.813,185.9375" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="386.8193" x2="276.813" y1="115.9688" y2="115.9688"/><line style="stroke:#181818;stroke-width:1;" x1="276.813" x2="276.813" y1="115.9688" y2="137.9688"/><polygon fill="#181818" points="272.813,127.9688,276.813,137.9688,280.813,127.9688,276.813,131.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="504.1475" x2="614.1538" y1="115.9688" y2="115.9688"/><line style="stroke:#181818;stroke-width:1;" x1="614.1538" x2="614.1538" y1="115.9688" y2="137.9688"/><polygon fill="#181818" points="610.1538,127.9688,614.1538,137.9688,618.1538,127.9688,614.1538,131.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="614.1538" x2="614.1538" y1="171.9375" y2="323.9063"/><line style="stroke:#181818;stroke-width:1;" x1="614.1538" x2="457.4834" y1="323.9063" y2="323.9063"/><polygon fill="#181818" points="467.4834,319.9063,457.4834,323.9063,467.4834,327.9063,463.4834,323.9063" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="83.9688" y2="103.9688"/><polygon fill="#181818" points="441.4834,93.9688,445.4834,103.9688,449.4834,93.9688,445.4834,97.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="335.9063" y2="355.9063"/><polygon fill="#181818" points="441.4834,345.9063,445.4834,355.9063,449.4834,345.9063,445.4834,349.9063" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="492.2461" y2="512.2461"/><polygon fill="#181818" points="441.4834,502.2461,445.4834,512.2461,449.4834,502.2461,445.4834,506.2461" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="546.2148" y2="566.2148"/><polygon fill="#181818" points="441.4834,556.2148,445.4834,566.2148,449.4834,556.2148,445.4834,560.2148" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="433.875" y2="458.2773"/><polygon fill="#181818" points="441.4834,448.2773,445.4834,458.2773,449.4834,448.2773,445.4834,452.2773" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="533.2803" x2="545.2803" y1="421.875" y2="421.875"/><polygon fill="#181818" points="541.2803,510.2461,545.2803,520.2461,549.2803,510.2461,545.2803,514.2461" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="545.2803" x2="545.2803" y1="421.875" y2="610.2148"/><line style="stroke:#181818;stroke-width:1;" x1="545.2803" x2="445.4834" y1="610.2148" y2="610.2148"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="610.2148" y2="630.2148"/><polygon fill="#181818" points="441.4834,620.2148,445.4834,630.2148,449.4834,620.2148,445.4834,624.2148" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="445.4834" x2="445.4834" y1="389.875" y2="409.875"/><polygon fill="#181818" points="441.4834,399.875,445.4834,409.875,449.4834,399.875,445.4834,403.875" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="217.4697" x2="217.4697" y1="698.1836" y2="718.1836"/><polygon fill="#181818" points="213.4697,708.1836,217.4697,718.1836,221.4697,708.1836,217.4697,712.1836" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="97.043" x2="97.043" y1="840.1211" y2="860.1211"/><polygon fill="#181818" points="93.043,850.1211,97.043,860.1211,101.043,850.1211,97.043,854.1211" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="97.043" x2="97.043" y1="894.0898" y2="914.0898"/><polygon fill="#181818" points="93.043,904.0898,97.043,914.0898,101.043,904.0898,97.043,908.0898" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="97.043" x2="97.043" y1="948.0586" y2="968.0586"/><polygon fill="#181818" points="93.043,958.0586,97.043,968.0586,101.043,958.0586,97.043,962.0586" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="337.8965" x2="337.8965" y1="840.1211" y2="860.1211"/><polygon fill="#181818" points="333.8965,850.1211,337.8965,860.1211,341.8965,850.1211,337.8965,854.1211" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="337.8965" x2="337.8965" y1="894.0898" y2="914.0898"/><polygon fill="#181818" points="333.8965,904.0898,337.8965,914.0898,341.8965,904.0898,337.8965,908.0898" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="337.8965" x2="337.8965" y1="948.0586" y2="968.0586"/><polygon fill="#181818" points="333.8965,958.0586,337.8965,968.0586,341.8965,958.0586,337.8965,962.0586" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="151.2002" x2="97.043" y1="784.1523" y2="784.1523"/><line style="stroke:#181818;stroke-width:1;" x1="97.043" x2="97.043" y1="784.1523" y2="806.1523"/><polygon fill="#181818" points="93.043,796.1523,97.043,806.1523,101.043,796.1523,97.043,800.1523" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="283.7393" x2="337.8965" y1="784.1523" y2="784.1523"/><line style="stroke:#181818;stroke-width:1;" x1="337.8965" x2="337.8965" y1="784.1523" y2="806.1523"/><polygon fill="#181818" points="333.8965,796.1523,337.8965,806.1523,341.8965,796.1523,337.8965,800.1523" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="217.4697" x2="217.4697" y1="752.1523" y2="772.1523"/><polygon fill="#181818" points="213.4697,762.1523,217.4697,772.1523,221.4697,762.1523,217.4697,766.1523" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="673.4971" x2="673.4971" y1="698.1836" y2="718.1836"/><polygon fill="#181818" points="669.4971,708.1836,673.4971,718.1836,677.4971,708.1836,673.4971,712.1836" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="673.4971" x2="673.4971" y1="752.1523" y2="772.1523"/><polygon fill="#181818" points="669.4971,762.1523,673.4971,772.1523,677.4971,762.1523,673.4971,766.1523" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="378.4753" x2="217.4697" y1="642.2148" y2="642.2148"/><line style="stroke:#181818;stroke-width:1;" x1="217.4697" x2="217.4697" y1="642.2148" y2="664.2148"/><polygon fill="#181818" points="213.4697,654.2148,217.4697,664.2148,221.4697,654.2148,217.4697,658.2148" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="512.4915" x2="673.4971" y1="642.2148" y2="642.2148"/><line style="stroke:#181818;stroke-width:1;" x1="673.4971" x2="673.4971" y1="642.2148" y2="664.2148"/><polygon fill="#181818" points="669.4971,654.2148,673.4971,664.2148,677.4971,654.2148,673.4971,658.2148" style="stroke:#181818;stroke-width:1;"/><!--SRC=[bPB1KeCm54NtVCLRXeNz05WuID4oewqYTU76YUb3Ceq99a7gtni2MbGSHtOXxzupzzqOIxKDWYWL7AM50bzQD3OE0bu1ATKU9IIlb0lwAF0q15kx7-GDJHY0-wAqHhO7Rlpa7HLyHyBON_NwIyMeM5AB9N_6XLGTkLSIDrLbq2wsPHekk3d3IcaajZV83WtNR-5FZcSLQ5ij0G_SM2wVm4lYptjZLUCFA0m2aMeY7O9WRu-xGO9onwlWwsoqLeChq8_CSJ0C1b72NbedTojoYz9KMfTkFovggLetUyBwRKGmq5xxRSoih421r565bq-JJGBvC2Ev1p0g2wmqcjgRat2k2oe4w64gOGoD6MT7olNcjdGCkE9CAwCg2nUQDlMnhf40flNggXM_DD4skxxKtjsG43fkQt1rnjEkleUS1fNO_QSzvhpq1-rlI5bhrGqbP0U6ZULAaY8xBxBRrSDvabzcot0EFFSWPigQjK-svIfRbtcQbFbc_L1aDzky-EGSstm7]--></g></svg>